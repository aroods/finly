{% extends "base.html" %}
{% block content %}
<h2>All Transactions</h2>
<table class="table table-bordered table-striped">
  <thead>
    <tr>
      <th>Date</th>
      <th>Asset</th>
      <th>Category</th>
      <th>Type</th>
      <th>Quantity</th>
      <th>Price at Buy</th>
      <th>Total Cost</th>
      <th>Currency</th>
      <th>Events</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for tx in transactions %}
    <tr>
      <td>{{ tx[1] }}</td>
      <td>{{ tx[2] }}</td>
      <td>{{ tx[7] }}</td>
      <td>{{ tx[3] }}</td>
      <td>{{ "%.2f"|format(tx[4]) }}</td>
      <td>{{ "%.2f"|format(tx[5]) }}</td>
      <td>{{ "%.2f"|format(tx[4] * tx[5]) }}</td>
      <td>{{ tx[6] }}</td>
      <td>
        <button class="btn btn-link p-0 show-events-btn" data-symbol="{{ tx[2] }}" data-row="{{ tx[0] }}">&#x25BC;</button>
      </td>
      <td>
        <a class="btn btn-sm btn-secondary" href="{{ url_for('transactions.edit_transaction', tx_id=tx[0]) }}">Edit</a>
      </td>
    </tr>
    <tr class="event-row" id="event-row-{{ tx[0] }}" style="display:none;">
      <td colspan="10">
        <div class="event-dates-content" id="event-content-{{ tx[0] }}">Loading events...</div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  document.querySelectorAll('.show-events-btn').forEach(btn => {
      btn.addEventListener('click', function() {
          const txId = this.dataset.row;
          const symbol = this.dataset.symbol;
          const row = document.getElementById('event-row-' + txId);
          const content = document.getElementById('event-content-' + txId);
          // Toggle the row
          if (row.style.display === "none") {
              row.style.display = "";
              // If not already loaded, fetch event dates
              if (!content.dataset.loaded) {
                  fetch(`/api/event-dates?symbol=${symbol}`)
                    .then(resp => resp.json())
                    .then(data => {
                        let html = "";
                        if (data.error) {
                            html = "<span class='text-danger'>No data or error: " + data.error + "</span>";
                        } else {
                            html = "<ul class='mb-0'>";
                            if (data.dividend_date) html += `<li><b>Next Dividend Date:</b> ${data.dividend_date}</li>`;
                            if (data.earnings_date) html += `<li><b>Next Earnings Date:</b> ${data.earnings_date}</li>`;
                            if (data.future_earnings_dates && data.future_earnings_dates.length > 0) {
                                html += `<li><b>Future Earnings Dates:</b> ${data.future_earnings_dates.join(', ')}</li>`;
                            }
                            if (html === "<ul class='mb-0'>") html += "<li>No upcoming events found.</li>";
                            html += "</ul>";
                        }
                        content.innerHTML = html;
                        content.dataset.loaded = "1";
                    })
                    .catch(e => {
                        content.innerHTML = "<span class='text-danger'>Failed to load events.</span>";
                    });
              }
              this.innerHTML = "&#x25B2;"; // Up arrow
          } else {
              row.style.display = "none";
              this.innerHTML = "&#x25BC;"; // Down arrow
          }
      });
  });
  </script>
{% endblock %}
