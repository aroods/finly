{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
  <div>
    <h1 class="h3 fw-semibold mb-1">Portfolio Dashboard</h1>
    <p class="text-muted mb-0">Modern overview of your holdings, performance, and allocation.</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <form method="POST" action="{{ url_for('dashboard.clear_cache') }}">
      <input type="hidden" name="prefix" value="price:">
      <button class="btn btn-outline-primary" type="submit">Clear Price Cache</button>
    </form>
    <form method="POST" action="{{ url_for('dashboard.clear_cache') }}">
      <input type="hidden" name="prefix" value="events:">
      <button class="btn btn-outline-secondary" type="submit">Clear Events Cache</button>
    </form>
    <form method="POST" action="{{ url_for('dashboard.clear_cache') }}">
      <button class="btn btn-outline-danger" type="submit">Clear ALL Cache</button>
    </form>
  </div>
</div>

{% if cache_stats %}
  <div class="pill-badge mb-4">
    Cache entries: {{ cache_stats.total_items }} · Oldest: {{ cache_stats.oldest if cache_stats.oldest is not none else 'n/a' }} · Latest: {{ cache_stats.newest if cache_stats.newest is not none else 'n/a' }}
  </div>
{% endif %}

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card glow-shadow h-100">
      <div class="card-body">
        <p class="text-muted text-uppercase mb-1" style="font-size:.7rem; letter-spacing:.16em;">Total Portfolio Value</p>
        <h3 class="fw-semibold mb-2">{{ "%.2f"|format(total_value_pln) }} PLN</h3>
        <span class="text-muted small">Including cash and market value</span>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted text-uppercase mb-1" style="font-size:.7rem; letter-spacing:.16em;">Total Profit</p>
        <h3 class="fw-semibold mb-2">{{ "%.2f"|format(total_profit_pln) }} PLN</h3>
        {% if total_profit_pln >= 0 %}
          <span class="text-success small">On track • Keep up the momentum</span>
        {% else %}
          <span class="text-danger small">Review positions for optimisations</span>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted text-uppercase mb-1" style="font-size:.7rem; letter-spacing:.16em;">Cash Position</p>
        <h3 class="fw-semibold mb-2">{{ "%.2f"|format(current_cash) }} PLN</h3>
        <span class="text-muted small">Available liquidity for next moves</span>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-lg-6">
    {% if profit_series %}
    <div class="card chart-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
          <h5 class="card-title mb-0">Profit Trend (PLN)</h5>
          <span class="text-muted">Total: {{ "%.2f"|format(total_profit_pln) }} PLN</span>
        </div>
        <canvas id="profitChart" height="180"></canvas>
      </div>
    </div>
    {% endif %}
  </div>
  <div class="col-12 col-lg-6">
    <div class="card chart-card h-100">
      <div class="card-body">
        <h5 class="card-title mb-3">Allocation (PLN)</h5>
        <canvas id="pieChart" height="180"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h5 class="card-title mb-3">Holdings Breakdown</h5>
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>Asset</th>
            <th>Category</th>
            <th>Currency</th>
            <th class="text-end">Quantity</th>
            <th class="text-end">Avg Cost</th>
            <th class="text-end">Investment (PLN)</th>
            <th class="text-end">Current Price</th>
            <th class="text-end">Value (PLN)</th>
            <th class="text-end">Profit/Loss (PLN)</th>
            <th class="text-end">Profit/Loss (%)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in dashboard_rows %}
          <tr>
            <td class="fw-semibold">{{ row.asset }}</td>
            <td><span class="pill-badge">{{ row.category }}</span></td>
            <td>{{ row.currency }}</td>
            <td class="text-end">{{ "%.2f"|format(row.quantity) }}</td>
            <td class="text-end">{{ "%.2f"|format(row.weighted_avg_price_local) }} {{ row.currency }}</td>
            <td class="text-end">{{ "%.2f"|format(row.investment_cost_pln) }}</td>
            <td class="text-end">{{ "%.2f"|format(row.current_price_local) }} {{ row.currency }}</td>
            <td class="text-end">{{ "%.2f"|format(row.current_value_pln) }}</td>
            <td class="text-end {% if row.profit_loss_pln >= 0 %}text-success{% else %}text-danger{% endif %}">
              {{ "%.2f"|format(row.profit_loss_pln) }}
            </td>
            <td class="text-end {% if row.profit_loss_pln >= 0 %}text-success{% else %}text-danger{% endif %}">
              {{ "%.2f"|format(row.profit_loss_perc) }}%
            </td>
          </tr>
          {% endfor %}
          <tr>
            <td class="fw-semibold">Cash</td>
            <td><span class="pill-badge">Deposit</span></td>
            <td>PLN</td>
            <td class="text-end">-</td>
            <td class="text-end">-</td>
            <td class="text-end">-</td>
            <td class="text-end">-</td>
            <td class="text-end">{{ "%.2f"|format(current_cash) }}</td>
            <td class="text-end">-</td>
            <td class="text-end">-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const pieLabels = {{ pie_labels|tojson }};
const pieData   = {{ pie_values|tojson }};
if (pieLabels.length && pieData.length) {
  new Chart(document.getElementById('pieChart').getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: pieLabels,
        datasets: [{
          data: pieData,
          backgroundColor: [
            '#38bdf8','#818cf8','#f472b6','#fb7185','#f97316','#facc15',
            '#4ade80','#34d399','#22d3ee','#a855f7','#64748b'
          ],
          borderWidth: 0,
          hoverOffset: 12
        }]
      },
      options: {
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#cbd5f5',
              boxWidth: 14,
              padding: 18
            }
          }
        },
        cutout: '60%'
      }
  });
}

const profitSeries = {{ profit_series|tojson }};
if (profitSeries && profitSeries.length) {
    const profitCtx = document.getElementById('profitChart').getContext('2d');
    const profitLabels = profitSeries.map(point => point.date);
    const profitData = profitSeries.map(point => point.value);
    const gradient = profitCtx.createLinearGradient(0, 0, 0, 260);
    gradient.addColorStop(0, 'rgba(56, 189, 248, 0.45)');
    gradient.addColorStop(1, 'rgba(56, 189, 248, 0.05)');

    new Chart(profitCtx, {
        type: 'line',
        data: {
            labels: profitLabels,
            datasets: [{
                label: 'Total Profit (PLN)',
                data: profitData,
                borderColor: '#38bdf8',
                backgroundColor: gradient,
                tension: 0.35,
                fill: true,
                pointRadius: 0,
                borderWidth: 2.5
            }]
        },
        options: {
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    ticks: { maxTicksLimit: 8, color: '#94a3b8' },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#94a3b8',
                        callback: (value) => typeof value === 'number' ? value.toFixed(0) : value
                    },
                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                }
            }
        }
    });
}
</script>
{% endblock %}
