{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
  <div>
    <h1 class="h3 fw-semibold mb-1">Portfolio Dashboard</h1>
    <p class="text-muted mb-0">Modern overview of your holdings, performance, bonds, and allocation.</p>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Admin tools">
      ⚙
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li>
        <form method="POST" action="{{ url_for('dashboard.clear_cache') }}" class="px-3 py-1">
          <input type="hidden" name="prefix" value="price:">
          <button class="btn btn-link p-0" type="submit">Clear Price Cache</button>
        </form>
      </li>
      <li>
        <form method="POST" action="{{ url_for('dashboard.clear_cache') }}" class="px-3 py-1">
          <input type="hidden" name="prefix" value="events:">
          <button class="btn btn-link p-0" type="submit">Clear Events Cache</button>
        </form>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <form method="POST" action="{{ url_for('dashboard.clear_cache') }}" class="px-3 py-1">
          <button class="btn btn-link text-danger p-0" type="submit">Clear ALL Cache</button>
        </form>
      </li>
    </ul>
  </div>

</div>

{% set portfolio_profit_positive = total_profit_pln >= 0 %}
{% set equity_profit_positive = equity_profit_total >= 0 %}

{% if cache_stats %}
  <div class="pill-badge mb-4">
    Cache entries: {{ cache_stats.total_items }} · Oldest: {{ cache_stats.oldest if cache_stats.oldest is not none else 'n/a' }} · Latest: {{ cache_stats.newest if cache_stats.newest is not none else 'n/a' }}
  </div>
{% endif %}

<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card glow-shadow h-100">
      <div class="card-body">
        <p class="text-muted text-uppercase mb-1" style="font-size:.7rem; letter-spacing:.16em;">Total Portfolio Value</p>
        <h3 class="fw-semibold mb-2 text-highlight">{{ "%.2f"|format(total_value_pln) }} PLN</h3>
        <span class="text-muted small">
          Net profit:
          <span class="{{ 'text-profit-positive' if portfolio_profit_positive else 'text-profit-negative' }}">
            {{ "%.2f"|format(total_profit_pln) }} PLN
          </span>
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted text-uppercase mb-1" style="font-size:.7rem; letter-spacing:.16em;">Equities &amp; ETFs</p>
        <h3 class="fw-semibold mb-2 text-highlight">{{ "%.2f"|format(equity_total_value) }} PLN</h3>
        <span class="{{ 'text-profit-positive' if equity_profit_positive else 'text-profit-negative' }} small">
          {{ 'Profit' if equity_profit_positive else 'Loss' }}: {{ "%.2f"|format(equity_profit_total) }} PLN
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted text-uppercase mb-1" style="font-size:.7rem; letter-spacing:.16em;">Bond Value</p>
        <h3 class="fw-semibold mb-2 text-highlight">{{ "%.2f"|format(bond_total_value) }} PLN</h3>
        <span class="text-profit-positive small">Accrued: {{ bond_total_accrued|format_currency() }}</span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <p class="text-muted text-uppercase mb-1" style="font-size:.7rem; letter-spacing:.16em;">Cash Position</p>
        <h3 class="fw-semibold mb-2 text-highlight">{{ "%.2f"|format(current_cash) }} PLN</h3>
        <span class="text-muted small">Ready-to-deploy liquidity</span>
      </div>
    </div>
  </div>
</div>
<div class="row g-3 mb-4">
  <div class="col-12 col-lg-6">
    {% if profit_series %}
    <div class="card chart-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
          <h5 class="card-title mb-0">Profit Trend (PLN)</h5>
          <span class="text-muted">Total: {{ "%.2f"|format(total_profit_pln) }} PLN</span>
        </div>
        <canvas id="profitChart" height="180"></canvas>
      </div>
    </div>
    {% endif %}
  </div>
  <div class="col-12 col-lg-6">
    <div class="card chart-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0" id="pieTitle">Allocation (PLN)</h5>
          <button id="pieBackButton" type="button" class="btn btn-sm btn-outline-secondary d-none">Back</button>
        </div>
        <canvas id="pieChart" height="180"></canvas>
        <p id="pieCaption" class="text-muted small mt-3 mb-0">Click a category to drill down into details.</p>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h5 class="card-title mb-3">Equity Holdings</h5>
    <div class="table-responsive">
      <table class="table align-middle mb-0 table-striped">
        <thead>
          <tr>
            <th>Asset</th>
            <th>Category</th>
            <th>Currency</th>
            <th class="text-end">Quantity</th>
            <th class="text-end">Avg Cost</th>
            <th class="text-end">Investment (PLN)</th>
            <th class="text-end">Current Price</th>
            <th class="text-end">Value (PLN)</th>
            <th class="text-end">Profit/Loss (PLN)</th>
            <th class="text-end">Profit/Loss (%)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in dashboard_rows %}
          <tr>
            <td class="fw-semibold">
              <div class="d-flex align-items-center gap-2">
                {% if row.logo_url %}
                <img src="{{ row.logo_url }}" alt="{{ row.asset }} logo" class="rounded-circle" style="width:24px;height:24px;object-fit:contain;">
                {% endif %}
                <span>{{ row.asset }}</span>
              </div>
            </td>
            <td><span class="pill-badge">{{ row.category }}</span></td>
            <td>{{ row.currency }}</td>
            <td class="text-end">{{ row.quantity|format_number(4) }}</td>
            <td class="text-end">{{ row.weighted_avg_price_local|format_currency(row.currency) }}</td>
            <td class="text-end">{{ row.investment_cost_pln|format_currency() }}</td>
            <td class="text-end">{{ row.current_price_local|format_currency(row.currency) }}</td>
            <td class="text-end">{{ row.current_value_pln|format_currency() }}</td>
            <td class="text-end {% if row.profit_loss_pln >= 0 %}text-profit-positive{% else %}text-profit-negative{% endif %}">
              {{ row.profit_loss_pln|format_signed_currency() }}
            </td>
            <td class="text-end {% if row.profit_loss_pln >= 0 %}text-profit-positive{% else %}text-profit-negative{% endif %}">
              {{ row.profit_loss_perc|format_percentage }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if bond_rows %}
<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title mb-3">Bond Positions</h5>
    <div class="table-responsive">
      <table class="table align-middle mb-0 table-striped">
        <thead>
          <tr>
            <th>Series</th>
            <th>Type</th>
            <th>Purchase</th>
            <th>Maturity</th>
            <th class="text-end">Nominal (PLN)</th>
            <th class="text-end">Accrued (PLN)</th>
            <th class="text-end">Current Value (PLN)</th>
          </tr>
        </thead>
        <tbody>
          {% for bond, accrual, logo_url in bond_rows %}
          <tr>
            <td>
            <div class="d-flex align-items-center gap-2">
              {% if logo_url %}
              <img src="{{ logo_url }}" alt="{{ bond.series }} logo" class="rounded-circle" style="width:24px;height:24px;object-fit:contain;">
              {% endif %}
              <span class="fw-semibold">{{ bond.series }}</span>
            </div>
          </td>
            <td><span class="pill-badge">{{ bond.bond_type|title }}</span></td>
            <td>{{ bond.purchase_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ bond.maturity_date.strftime('%Y-%m-%d') }}</td>
            <td class="text-end">{{ bond.principal|format_currency() }}</td>
            <td class="text-end {% if accrual['accrued_interest'] >= 0 %}text-profit-positive{% else %}text-profit-negative{% endif %}">{{ accrual['accrued_interest']|format_signed_currency() }}</td>
            <td class="text-end">{{ accrual['current_value']|format_currency() }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<script>
const pieOverview = {{ pie_overview|tojson }};
const pieDetailMap = {{ pie_detail_map|tojson }};
let pieChartInstance = null;
let currentPieLevel = 'overview';
let currentParentLabel = null;

const pieCanvas = document.getElementById('pieChart');
const pieCtx = pieCanvas.getContext('2d');
const pieBackButton = document.getElementById('pieBackButton');
const pieTitle = document.getElementById('pieTitle');
const pieCaption = document.getElementById('pieCaption');

function buildDataset(items, colors) {
  const labels = items.map(item => item.label);
  const values = items.map(item => item.value);
  const palette = [];
  if (colors && colors.length) {
    for (let i = 0; i < labels.length; i++) {
      palette.push(colors[i % colors.length]);
    }
  } else {
    const fallback = ['#38bdf8', '#10b981', '#facc15', '#818cf8', '#f472b6'];
    for (let i = 0; i < labels.length; i++) {
      palette.push(fallback[i % fallback.length]);
    }
  }
  return {
    labels: labels,
    datasets: [{
      data: values,
      backgroundColor: palette,
      borderWidth: 0,
      hoverOffset: 12
    }]
  };
}

function renderPie(level, parentLabel) {
  let dataset;
  if (pieChartInstance) {
    pieChartInstance.destroy();
  }

  if (level === 'overview') {
    dataset = buildDataset(pieOverview, pieOverview.map(item => item.color));
    pieChartInstance = new Chart(pieCtx, {
      type: 'doughnut',
      data: dataset,
      options: {
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#cbd5f5',
              boxWidth: 14,
              padding: 18
            }
          }
        },
        cutout: '60%'
      }
    });
    currentPieLevel = 'overview';
    currentParentLabel = null;
    pieBackButton.classList.add('d-none');
    pieTitle.textContent = 'Allocation (PLN)';
    pieCaption.textContent = 'Click a category to drill down into details.';
  } else {
    const detail = pieDetailMap[parentLabel];
    if (!detail || !detail.data.length) {
      renderPie('overview');
      return;
    }
    dataset = buildDataset(detail.data, detail.colors);
    pieChartInstance = new Chart(pieCtx, {
      type: 'doughnut',
      data: dataset,
      options: {
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#cbd5f5',
              boxWidth: 14,
              padding: 18
            }
          }
        },
        cutout: '60%'
      }
    });
    currentPieLevel = 'detail';
    currentParentLabel = parentLabel;
    pieBackButton.classList.remove('d-none');
    pieTitle.textContent = parentLabel + ' Breakdown';
    pieCaption.textContent = 'Use the back button or click the chart to return to the main view.';
  }
}

pieBackButton.addEventListener('click', () => renderPie('overview'));

pieCanvas.addEventListener('click', (event) => {
  if (!pieChartInstance) {
    return;
  }
  const elements = pieChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, false);
  if (!elements.length) {
    return;
  }
  const index = elements[0].index;
  const label = pieChartInstance.data.labels[index];
  if (currentPieLevel === 'overview') {
    const detail = pieDetailMap[label];
    if (detail && detail.data.length > 1) {
      renderPie('detail', label);
    }
  } else {
    renderPie('overview');
  }
});

renderPie('overview');

const profitSeries = {{ profit_series|tojson }};
if (profitSeries && profitSeries.length) {
    const profitCtx = document.getElementById('profitChart').getContext('2d');
    const profitLabels = profitSeries.map(point => point.date);
    const profitData = profitSeries.map(point => point.value);
    const gradient = profitCtx.createLinearGradient(0, 0, 0, 260);
    gradient.addColorStop(0, 'rgba(56, 189, 248, 0.45)');
    gradient.addColorStop(1, 'rgba(56, 189, 248, 0.05)');

    new Chart(profitCtx, {
        type: 'line',
        data: {
            labels: profitLabels,
            datasets: [{
                label: 'Total Profit (PLN)',
                data: profitData,
                borderColor: '#38bdf8',
                backgroundColor: gradient,
                tension: 0.35,
                fill: true,
                pointRadius: 0,
                borderWidth: 2.5
            }]
        },
        options: {
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    ticks: { maxTicksLimit: 8, color: '#94a3b8' },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#94a3b8',
                        callback: (value) => typeof value === 'number' ? value.toFixed(0) : value
                    },
                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                }
            }
        }
    });
}
</script>
{% endblock %}
