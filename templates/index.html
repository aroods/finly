{% extends "base.html" %}
{% block content %}
<h2>Dashboard</h2>

<!-- Refresh & Cache Controls -->
<div class="d-flex flex-wrap gap-2 mb-3">
  <a href="{{ url_for('dashboard.refresh_prices') }}" class="btn btn-info">Refresh Prices</a>

  <form method="POST" action="{{ url_for('dashboard.clear_cache') }}">
    <input type="hidden" name="prefix" value="price:">
    <button class="btn btn-outline-primary" type="submit">Clear Price Cache</button>
  </form>

  <form method="POST" action="{{ url_for('dashboard.clear_cache') }}">
    <input type="hidden" name="prefix" value="events:">
    <button class="btn btn-outline-secondary" type="submit">Clear Events Cache</button>
  </form>

  <form method="POST" action="{{ url_for('dashboard.clear_cache') }}">
    <button class="btn btn-outline-danger" type="submit">Clear ALL Cache</button>
  </form>
</div>

{% if cache_stats %}
  <div class="text-muted small mb-3">
    Cache entries: {{ cache_stats.total_items }} |
    Oldest age: {{ cache_stats.oldest if cache_stats.oldest is not none else 'n/a' }} |
    Newest age: {{ cache_stats.newest if cache_stats.newest is not none else 'n/a' }}
  </div>
{% endif %}

<!-- Asset Allocation Pie Chart -->
<div class="text-center" style="max-width: 400px; margin: auto;">
  <canvas id="pieChart" style="max-width: 100%; height: 220px;"></canvas>
</div>

<!-- Portfolio Summary Table -->
<table class="table table-bordered table-striped">
  <thead>
    <tr>
      <th>Asset</th>
      <th>Category</th>
      <th>Quantity</th>
      <th>Weighted Avg Price</th>
      <th>Investment Cost</th>
      <th>Current Price</th>
      <th>Value (Current)</th>
      <th>Profit/Loss (PLN)</th>
      <th>Profit/Loss (%)</th>
    </tr>
  </thead>
  <tbody>
    {% for row in dashboard_rows %}
    <tr>
      <td>{{ row.asset }}</td>
      <td>{{ row.category }}</td>
      <td>{{ "%.2f"|format(row.quantity) }}</td>
      <td>{{ "%.2f"|format(row.weighted_avg_price) }}</td>
      <td>{{ "%.2f"|format(row.investment_cost) }}</td>
      <td>{{ "%.2f"|format(row.current_price) }}</td>
      <td>{{ "%.2f"|format(row.current_value) }}</td>
      <td>{{ "%.2f"|format(row.profit_loss_pln) }}</td>
      <td>{{ "%.2f"|format(row.profit_loss_perc) }}%</td>
    </tr>
    {% endfor %}
    <tr>
      <td>Cash</td>
      <td>Deposit</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>{{ "%.2f"|format(current_cash) }}</td>
      <td>-</td>
      <td>-</td>
    </tr>
  </tbody>
</table>

<!-- Pie chart JS -->
<script>
const pieLabels = {{ pie_labels|tojson }};
const pieData   = {{ pie_values|tojson }};
new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
      labels: pieLabels,
      datasets: [{ data: pieData }]
    }
});
</script>
{% endblock %}
