{% extends "base.html" %}
{% block content %}
<h2>Edit Transaction</h2>
<form method="POST">
  <div class="mb-3">
    <label for="date" class="form-label">Date</label>
    <input type="date" id="date" name="date" class="form-control" value="{{ tx[1] }}" required>
  </div>
  <div class="mb-3 position-relative">
    <label for="asset" class="form-label">Asset (Ticker Symbol)</label>
    <input type="text" id="asset" name="asset" class="form-control" value="{{ tx[2] }}" autocomplete="off" required>
    <div id="suggestions" class="list-group position-absolute" style="z-index: 1000; width: 100%;"></div>
    <div class="form-text">Start typing ticker or company name, then select from the dropdown.</div>
  </div>
  <div class="mb-3">
    <label for="type" class="form-label">Type</label>
    <select id="type" name="type" class="form-select" required>
      <option value="buy" {% if tx[3] == 'buy' %}selected{% endif %}>Buy</option>
      <option value="sell" {% if tx[3] == 'sell' %}selected{% endif %}>Sell</option>
    </select>
  </div>
  <div class="mb-3">
    <label for="quantity" class="form-label">Quantity</label>
    <input type="number" id="quantity" name="quantity" step="any" class="form-control" value="{{ tx[4] }}" required>
  </div>
  <div class="mb-3">
    <label for="price" class="form-label">Price per Unit</label>
    <input type="number" id="price" name="price" step="any" class="form-control" value="{{ tx[5] }}" required>
  </div>
  <div class="mb-3">
    <label for="currency" class="form-label">Currency</label>
    <input type="text" id="currency" name="currency" class="form-control" value="{{ tx[6] }}" required>
  </div>
  <div class="mb-3">
    <label for="category" class="form-label">Category</label>
    <select id="category" name="category" class="form-select" required>
      <option value="Stock" {% if tx[7] == 'Stock' %}selected{% endif %}>Stock</option>
      <option value="ETF" {% if tx[7] == 'ETF' %}selected{% endif %}>ETF</option>
      <option value="Bond" {% if tx[7] == 'Bond' %}selected{% endif %}>Bond</option>
      <option value="Crypto" {% if tx[7] == 'Crypto' %}selected{% endif %}>Crypto</option>
    </select>
  </div>
  <button type="submit" class="btn btn-primary">Save Changes</button>
  <a href="{{ url_for('transactions.all_transactions') }}" class="btn btn-secondary ms-2">Cancel</a>
</form>

<!-- Autocomplete script for ticker symbol (Yahoo search) -->
<script>
let debounceTimeout;
const assetInput = document.getElementById('asset');
const suggestions = document.getElementById('suggestions');
assetInput.addEventListener('input', function() {
    clearTimeout(debounceTimeout);
    const q = assetInput.value;
    if (q.length < 2) {
        suggestions.innerHTML = '';
        return;
    }
    debounceTimeout = setTimeout(() => {
        fetch(`/api/yahoo-search?q=${encodeURIComponent(q)}`)
            .then(response => response.json())
            .then(data => {
                suggestions.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-group-item list-group-item-action';
                    div.textContent = `${item.ticker} â€” ${item.name}${item.exchange ? ' ('+item.exchange+')' : ''}`;
                    div.onclick = function() {
                        assetInput.value = item.ticker;
                        suggestions.innerHTML = '';
                    }
                    suggestions.appendChild(div);
                });
            });
    }, 400);
});
document.addEventListener('click', function(e) {
    if (e.target !== assetInput) {
        suggestions.innerHTML = '';
    }
});
</script>
{% endblock %}
