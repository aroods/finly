{% extends "base.html" %}
{% block content %}
<div class="col-lg-8 mx-auto">
  <div class="card">
    <div class="card-body">
      <h2 class="h4 fw-semibold mb-4">Add Transaction</h2>
      <form method="POST" class="row g-3">
        <div class="col-md-6">
          <label for="date" class="form-label">Date</label>
          <input type="date" id="date" name="date" class="form-control" value="{{ today }}" required>
        </div>
        <div class="col-md-6 position-relative">
          <label for="asset" class="form-label">Asset (Ticker Symbol)</label>
          <input type="text" id="asset" name="asset" class="form-control" autocomplete="off" required>
          <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
          <div class="form-text">Start typing ticker or company name, then select.</div>
        </div>
        <div class="col-md-6">
          <label for="type" class="form-label">Type</label>
          <select id="type" name="type" class="form-select" required>
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="quantity" class="form-label">Quantity</label>
          <input type="number" id="quantity" name="quantity" step="any" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label for="price" class="form-label">Price per Unit</label>
          <input type="number" id="price" name="price" step="any" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label for="currency" class="form-label">Currency</label>
          <input type="text" id="currency" name="currency" class="form-control" value="PLN" required>
        </div>
        <div class="col-md-6">
          <label for="category" class="form-label">Category</label>
          <select id="category" name="category" class="form-select" required>
            <option value="Stock">Stock</option>
            <option value="ETF">ETF</option>
            <option value="Bond">Bond</option>
            <option value="Crypto">Crypto</option>
          </select>
        </div>
        <div class="col-12 d-flex justify-content-end gap-2 pt-3">
          <a href="{{ url_for('transactions.all_transactions') }}" class="btn btn-outline-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">Add Transaction</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let debounceTimeout;
const assetInput = document.getElementById('asset');
const suggestions = document.getElementById('suggestions');
const currencyInput = document.getElementById('currency');

function fetchCurrency(ticker) {
    if (!ticker || ticker.length < 1) return;
    fetch(`/api/get-currency?symbol=${encodeURIComponent(ticker)}`)
        .then(resp => resp.json())
        .then(data => {
            if (data.currency) {
                currencyInput.value = data.currency.toUpperCase();
            }
        })
        .catch(() => {
            // leave existing currency in place
        });
}

assetInput.addEventListener('blur', function() {
    fetchCurrency(this.value.trim());
});
</script>
{% endblock %}
